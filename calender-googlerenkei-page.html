<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>スケジュール管理（Google連携・日付/カレンダー・Import/Export）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root { --bg:#f7f7fa; --card:#fff; --line:#e5e7eb; --text:#111827; --muted:#6b7280; --accent:#111827; }
  * { box-sizing: border-box; }
  body { margin:0; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif; color:var(--text); }
  header { display:flex; gap:12px; justify-content:space-between; align-items:center; padding:14px 16px; background:#fff; border-bottom:1px solid var(--line); }
  header h1 { margin:0; font-size:18px; }
  .auth { display:flex; gap:8px; align-items:center; }
  button { border:1px solid var(--line); background:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; font:inherit; }
  button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
  button:disabled{ opacity:.6; cursor:not-allowed; }
  .hidden { display:none !important; }
  main { max-width:1000px; margin:18px auto 60px; padding:0 14px; display:grid; gap:16px; grid-template-columns:1.1fr 1fr; }
  @media (max-width:920px){ main{ grid-template-columns:1fr; } }
  .card { background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.04); }
  .card .head { padding:12px 14px; border-bottom:1px solid var(--line); display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .card .body { padding:14px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .grow { flex:1 1 auto; }
  .pill { padding:.2rem .6rem; background:#eef2f7; border-radius:999px; font-size:12px; }
  .muted{ color:var(--muted); }
  .textarea { width:100%; min-height:280px; padding:12px; border:1px solid var(--line); border-radius:10px; resize:vertical; font:inherit; }
  /* calendar */
  .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
  .cal-dow { text-align:center; font-size:12px; color:var(--muted); }
  .day { background:#fff; border:1px solid var(--line); border-radius:10px; min-height:70px; padding:6px; display:flex; flex-direction:column; gap:4px; }
  .day header { display:flex; justify-content:space-between; align-items:center; padding:0; border:none; }
  .day.inactive{ opacity:.5; }
  .day .num{ font-size:13px; }
  .dot{ width:8px; height:8px; border-radius:50%; background:#111827; display:inline-block; }
  .todayMark{ border-color:#111827; box-shadow:0 0 0 2px rgba(0,0,0,.04) inset; }
</style>
</head>
<body>

<header>
  <h1>スケジュール管理</h1>
  <div class="auth">
    <div id="user-info" class="muted">ログイン状態を確認中...</div>
    <button id="signInBtn" class="primary hidden">Googleでログイン</button>
    <button id="signOutBtn" class="hidden">ログアウト</button>
  </div>
</header>

<main id="app" class="hidden">
  <!-- 左：日付編集 -->
  <section class="card">
    <div class="head">
      <div class="row grow">
        <span class="pill">日付で編集 / 閲覧</span>
        <input id="datePicker" type="date" />
        <button id="todayBtn">今日</button>
      </div>
      <div class="row">
        <button id="saveBtn" class="primary">保存</button>
      </div>
    </div>
    <div class="body">
      <textarea id="scheduleText" class="textarea" placeholder="この日の予定をテキストで自由に書いてください"></textarea>
      <div class="row" style="justify-content:space-between; margin-top:10px">
        <span id="updatedAt" class="muted">保存日時: —</span>
      </div>
    </div>
  </section>

  <!-- 右：カレンダー -->
  <aside class="card">
    <div class="head">
      <div class="row grow"><span class="pill">カレンダー（月）</span></div>
      <div class="row">
        <button id="prevMonthBtn">◀ 前月</button>
        <strong id="monthLabel" style="min-width:9ch;text-align:center"></strong>
        <button id="nextMonthBtn">次月 ▶</button>
      </div>
    </div>
    <div class="body">
      <div class="cal-grid" style="margin-bottom:6px">
        <div class="cal-dow">日</div><div class="cal-dow">月</div><div class="cal-dow">火</div>
        <div class="cal-dow">水</div><div class="cal-dow">木</div><div class="cal-dow">金</div><div class="cal-dow">土</div>
      </div>
      <div id="calendar" class="cal-grid"></div>
      <div class="muted" style="margin-top:8px;font-size:12px">●＝保存済みのテキストがある日。クリックでその日を開きます。</div>
    </div>
  </aside>

  <!-- 下：インポート/エクスポート -->
  <section class="card" style="grid-column:1/-1">
    <div class="head">
      <div class="row grow"><span class="pill">インポート / エクスポート</span></div>
      <div class="row">
        <button id="exportBtn">エクスポート（JSON）</button>
        <label for="importFile" style="border:1px solid var(--line); padding:8px 10px; border-radius:8px; cursor:pointer">インポート（JSON）</label>
        <input id="importFile" type="file" accept="application/json" class="hidden" />
      </div>
    </div>
    <div class="body">
      <div class="muted" style="font-size:12px">
        エクスポート：あなたの全日付の予定をJSONで保存します。<br>
        インポート：同形式JSONで、該当日付に上書き保存します（あなたのデータにのみ反映）。
      </div>
    </div>
  </section>
</main>

<!-- ===== Firebase SDK v10.12.2（ご提示版に合わせています） ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, collection, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // === ここは「参考ページ」と同じ設定をそのまま採用（必要なら差し替え） ===
  const firebaseConfig = {
    apiKey: "AIzaSyDuNluIfeulzr_hCr7bHtnCxE1cBneB4kM",
    authDomain: "masu-memo.firebaseapp.com",
    projectId: "masu-memo",
    storageBucket: "masu-memo.appspot.com",
    messagingSenderId: "1065347011702",
    appId: "1:1065347011702:web:e417d565f28d000da83b57"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore();
  const provider = new GoogleAuthProvider();

  // ===== DOM参照 =====
  const appRoot = document.getElementById('app');
  const userInfo = document.getElementById('user-info');
  const signInBtn = document.getElementById('signInBtn');
  const signOutBtn = document.getElementById('signOutBtn');

  const datePicker = document.getElementById('datePicker');
  const todayBtn = document.getElementById('todayBtn');
  const scheduleText = document.getElementById('scheduleText');
  const saveBtn = document.getElementById('saveBtn');
  const updatedAtEl = document.getElementById('updatedAt');

  const prevMonthBtn = document.getElementById('prevMonthBtn');
  const nextMonthBtn = document.getElementById('nextMonthBtn');
  const monthLabel = document.getElementById('monthLabel');
  const calGrid = document.getElementById('calendar');

  const exportBtn = document.getElementById('exportBtn');
  const importFile = document.getElementById('importFile');

  // ===== Utils =====
  const TZ = 'Asia/Tokyo';
  const pad2 = n => String(n).padStart(2,'0');
  const toDateKey = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; // YYYY-MM-DD
  const fromDateInput = v => { const [y,m,d] = v.split('-').map(Number); return new Date(y, m-1, d); };
  const today = () => { const n = new Date(); return new Date(n.getFullYear(), n.getMonth(), n.getDate()); };
  const toHuman = dt => dt.toLocaleString('ja-JP', { timeZone: TZ, dateStyle:'medium', timeStyle:'short' });

  // 選択中
  let currentDate = today();
  let currentMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);

  // ===== 認証（ご提示形式を踏襲） =====
  async function signInWithGoogle(){
    try { await signInWithPopup(auth, provider); }
    catch(e){ console.error("Googleログインエラー:", e); alert("Googleログインに失敗しました: " + e.message); }
  }
  async function signOutUser(){ try{ await signOut(auth); } catch(e){ console.error("ログアウトエラー:", e); } }

  // グローバル公開（参考ページ互換）
  window.signInWithGoogle = signInWithGoogle;
  window.signOutUser = signOutUser;

  onAuthStateChanged(auth, async user => {
    if(user){
      userInfo.innerHTML = `こんにちは、${user.displayName || user.email} さん <button onclick="signOutUser()">ログアウト</button>`;
      appRoot.classList.remove('hidden');
      signInBtn.classList.add('hidden');   // 参考ボタン（予備）
      signOutBtn.classList.add('hidden');  // 参考ボタン（予備）
      // 初期表示
      setDatePicker(currentDate);
      await refreshEditor(user.uid);
      await buildCalendar(user.uid);
    }else{
      userInfo.innerHTML = `<button onclick="signInWithGoogle()">Googleでログイン</button>`;
      appRoot.classList.add('hidden');
      signInBtn.classList.add('hidden');   // 参考ボタン（予備）
      signOutBtn.classList.add('hidden');  // 参考ボタン（予備）
    }
  });

  // ===== Firestore I/O =====
  // ドキュメント：users/{uid}/schedules/{YYYY-MM-DD} => { text: string, updatedAt: Timestamp }
  async function loadSchedule(uid, dateKey){
    const ref = doc(db, 'users', uid, 'schedules', dateKey);
    const snap = await getDoc(ref);
    if(snap.exists()){
      const d = snap.data();
      return { text: d.text || '', updatedAt: d.updatedAt?.toDate?.() || null };
    }
    return { text: '', updatedAt: null };
  }
  async function saveSchedule(uid, dateKey, text){
    const ref = doc(db, 'users', uid, 'schedules', dateKey);
    await setDoc(ref, { text, updatedAt: new Date() }, { merge:true });
  }
  // 当月の保存有無を確認（簡易：全件取得→月でローカルフィルタ）
  async function listSchedulesForMonth(uid, year, monthIndex){
    const colRef = collection(db, 'users', uid, 'schedules');
    const all = await getDocs(colRef);
    const set = new Set();
    const monthStart = new Date(year, monthIndex, 1);
    const monthEnd   = new Date(year, monthIndex+1, 1);
    all.forEach(s=>{
      const id = s.id; // YYYY-MM-DD
      const m = id.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return;
      const d = new Date(+m[1], +m[2]-1, +m[3]);
      if(d >= monthStart && d < monthEnd){
        if((s.data()?.text || '').trim() !== '') set.add(id);
      }
    });
    return set;
  }

  // ===== 画面制御 =====
  function setDatePicker(date){
    datePicker.value = `${date.getFullYear()}-${pad2(date.getMonth()+1)}-${pad2(date.getDate())}`;
  }

  async function refreshEditor(uid){
    const key = toDateKey(currentDate);
    const { text, updatedAt } = await loadSchedule(uid, key);
    scheduleText.value = text || '';
    updatedAtEl.textContent = updatedAt ? `保存日時: ${toHuman(updatedAt)}` : '保存日時: —';
  }

  async function buildCalendar(uid){
    const y = currentMonth.getFullYear();
    const m = currentMonth.getMonth(); // 0-based
    monthLabel.textContent = `${y}年 ${m+1}月`;
    calGrid.innerHTML = '';

    const firstDay = new Date(y, m, 1).getDay();
    const daysInMonth = new Date(y, m+1, 0).getDate();
    const prevMonthDays = new Date(y, m, 0).getDate();

    const savedSet = await listSchedulesForMonth(uid, y, m);
    const totalCells = 42;

    for(let i=0;i<totalCells;i++){
      const cell = document.createElement('div');
      cell.className = 'day';
      const dayNum = i - firstDay + 1;
      let cellDate, inactive=false;

      if(i < firstDay){
        cellDate = new Date(y, m-1, prevMonthDays - (firstDay-1-i));
        inactive = true;
      }else if(dayNum > daysInMonth){
        cellDate = new Date(y, m+1, dayNum - daysInMonth);
        inactive = true;
      }else{
        cellDate = new Date(y, m, dayNum);
      }

      if(inactive) cell.classList.add('inactive');
      if(toDateKey(cellDate) === toDateKey(today())) cell.classList.add('todayMark');

      const head = document.createElement('header');
      const num = document.createElement('div'); num.className='num'; num.textContent = cellDate.getDate();
      const mark = document.createElement('div');
      if(savedSet.has(toDateKey(cellDate))){
        const dot = document.createElement('span'); dot.className='dot'; mark.appendChild(dot);
      }
      head.appendChild(num); head.appendChild(mark);

      const openBtn = document.createElement('button');
      openBtn.textContent = '開く';
      openBtn.addEventListener('click', async ()=>{
        currentDate = cellDate;
        setDatePicker(currentDate);
        const u = auth.currentUser; if(u){ await refreshEditor(u.uid); }
        currentMonth = new Date(cellDate.getFullYear(), cellDate.getMonth(), 1);
        if(u){ await buildCalendar(u.uid); }
        window.scrollTo({ top:0, behavior:'smooth' });
      });

      cell.appendChild(head);
      cell.appendChild(openBtn);
      calGrid.appendChild(cell);
    }
  }

  // ===== イベント =====
  datePicker.addEventListener('change', async ()=>{
    currentDate = fromDateInput(datePicker.value);
    currentMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const u = auth.currentUser; if(u){ await refreshEditor(u.uid); await buildCalendar(u.uid); }
  });

  todayBtn.addEventListener('click', async ()=>{
    currentDate = today();
    setDatePicker(currentDate);
    currentMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const u = auth.currentUser; if(u){ await refreshEditor(u.uid); await buildCalendar(u.uid); }
  });

  prevMonthBtn.addEventListener('click', async ()=>{
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1);
    const u = auth.currentUser; if(u){ await buildCalendar(u.uid); }
  });

  nextMonthBtn.addEventListener('click', async ()=>{
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1);
    const u = auth.currentUser; if(u){ await buildCalendar(u.uid); }
  });

  saveBtn.addEventListener('click', async ()=>{
    const u = auth.currentUser; if(!u) return alert('ログインしてください');
    saveBtn.disabled = true;
    try{
      await saveSchedule(u.uid, toDateKey(currentDate), scheduleText.value.trim());
      await refreshEditor(u.uid);
      await buildCalendar(u.uid);
    }catch(e){ alert('保存に失敗しました: ' + e.message); }
    finally{ saveBtn.disabled = false; }
  });

  exportBtn.addEventListener('click', async ()=>{
    const u = auth.currentUser; if(!u) return alert('ログインしてください');
    const colRef = collection(db, 'users', u.uid, 'schedules');
    const snaps = await getDocs(colRef);
    const out = {};
    snaps.forEach(s=>{
      const d = s.data();
      out[s.id] = { text: d.text || '', updatedAt: d.updatedAt?.toDate?.()?.toISOString?.() || null };
    });
    const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'schedules_export.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  importFile.addEventListener('change', async (e)=>{
    const u = auth.currentUser; if(!u) return alert('ログインしてください');
    const f = e.target.files?.[0]; if(!f) return;
    try{
      const text = await f.text();
      const json = JSON.parse(text);
      const batch = writeBatch(db);
      const keys = Object.keys(json);
      if(keys.length === 0) return alert('インポート対象がありません');

      keys.forEach(k=>{
        if(!/^\d{4}-\d{2}-\d{2}$/.test(k)) return;
        const ref = doc(db, 'users', u.uid, 'schedules', k);
        batch.set(ref, { text: String(json[k]?.text || ''), updatedAt: new Date() }, { merge:true });
      });
      await batch.commit();
      await refreshEditor(u.uid);
      await buildCalendar(u.uid);
      alert('インポートしました');
    }catch(err){
      console.error(err);
      alert('インポートに失敗しました: ' + err.message);
    }finally{
      importFile.value = '';
    }
  });

  // 予備（参考ボタン用）
  document.getElementById('signInBtn').addEventListener('click', signInWithGoogle);
  document.getElementById('signOutBtn').addEventListener('click', signOutUser);

  // 初期
  setDatePicker(currentDate);
</script>

<!-- Firestore ルール（例）：本番前に必ず設定してください
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId}/schedules/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
-->
</body>
</html>
