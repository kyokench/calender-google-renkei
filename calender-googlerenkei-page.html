<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>スケジュール管理（Googleログイン + 日付/カレンダー + Import/Export）</title>
<style>
  :root { --bg:#f7f7fa; --card:#fff; --line:#e5e7eb; --text:#111827; --muted:#6b7280; --accent:#111827; }
  * { box-sizing: border-box; }
  body { margin: 0; background: var(--bg); font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif; color: var(--text); }
  header { display:flex; justify-content:space-between; align-items:center; padding:14px 18px; background:#fff; border-bottom:1px solid var(--line); position:sticky; top:0; z-index:10; }
  header h1 { font-size:18px; margin:0; }
  header .auth { display:flex; gap:8px; align-items:center; }
  button, select, input, textarea { font: inherit; }
  button { border:1px solid var(--line); background:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; }
  button.primary { background: var(--accent); color:#fff; border-color: var(--accent); }
  button:disabled { opacity:.6; cursor:not-allowed; }
  main { max-width:1000px; margin: 18px auto 60px; padding: 0 14px; display:grid; gap:16px; grid-template-columns: 1.1fr 1fr; }
  @media (max-width: 920px) { main { grid-template-columns: 1fr; } }
  .card { background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.04); }
  .card .head { padding:12px 14px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .card .body { padding:14px; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .grow { flex: 1 1 auto; }
  .muted { color: var(--muted); }
  .textarea { width:100%; min-height:280px; padding:12px; border:1px solid var(--line); border-radius:10px; resize:vertical; }
  .footer { display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
  .pill { padding:.2rem .6rem; background:#f1f5f9; border-radius:999px; font-size:12px; color:#0f172a; }
  /* Calendar */
  .cal-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
  .cal-dow { text-align:center; font-size:12px; color:var(--muted); }
  .day { background:#fff; border:1px solid var(--line); border-radius:10px; min-height:70px; padding:6px; display:flex; flex-direction:column; gap:4px; }
  .day header { display:flex; justify-content:space-between; align-items:center; padding:0; border:none; position:static; }
  .day.inactive { opacity:.5; }
  .day .num { font-size:13px; }
  .dot { width:8px; height:8px; border-radius:50%; background:#111827; display:inline-block; }
  .day button { margin-top:auto; font-size:12px; padding:6px; }
  .todayMark { border-color:#111827; box-shadow:0 0 0 2px rgba(0,0,0,.04) inset; }
  /* Hidden sections when logged out */
  .hidden { display:none !important; }
  .note { font-size:12px; color:var(--muted); }
</style>
</head>
<body>
<header>
  <h1>スケジュール管理</h1>
  <div class="auth">
    <span id="userInfo" class="muted">未ログイン</span>
    <button id="signInBtn" class="primary">Googleでログイン</button>
    <button id="signOutBtn" class="hidden">ログアウト</button>
  </div>
</header>

<main id="app" class="hidden">
  <!-- 左：日付切替 + テキスト編集 -->
  <section class="card">
    <div class="head">
      <div class="row grow">
        <label class="pill">日付で編集 / 閲覧</label>
        <input id="datePicker" type="date" />
        <button id="todayBtn">今日</button>
      </div>
      <div class="row">
        <button id="saveBtn" class="primary">保存</button>
      </div>
    </div>
    <div class="body">
      <textarea id="scheduleText" class="textarea" placeholder="この日の予定を自由にテキストで書いてください"></textarea>
      <div class="footer">
        <span id="updatedAt" class="muted">—</span>
      </div>
    </div>
  </section>

  <!-- 右：カレンダー（月表示） -->
  <aside class="card">
    <div class="head">
      <div class="row grow">
        <label class="pill">カレンダービジュアル</label>
      </div>
      <div class="row">
        <button id="prevMonthBtn">◀ 前月</button>
        <strong id="monthLabel" style="min-width:9ch;text-align:center"></strong>
        <button id="nextMonthBtn">次月 ▶</button>
      </div>
    </div>
    <div class="body">
      <div class="cal-head row" style="gap:0">
        <div class="cal-grid" style="gap:6px">
          <div class="cal-dow">日</div><div class="cal-dow">月</div><div class="cal-dow">火</div>
          <div class="cal-dow">水</div><div class="cal-dow">木</div><div class="cal-dow">金</div><div class="cal-dow">土</div>
        </div>
      </div>
      <div id="calendar" class="cal-grid"></div>
      <div class="note" style="margin-top:8px">●は「テキストが保存されている日」です。日にちをクリックするとその日の編集画面に移動します。</div>
    </div>
  </aside>

  <!-- 下：インポート / エクスポート -->
  <section class="card" style="grid-column:1/-1">
    <div class="head">
      <div class="row grow">
        <label class="pill">インポート / エクスポート</label>
      </div>
      <div class="row">
        <button id="exportBtn">エクスポート（JSON）</button>
        <label for="importFile" class="button" style="border:1px solid var(--line);padding:8px 10px;border-radius:8px;cursor:pointer">インポート（JSON）</label>
        <input id="importFile" type="file" accept="application/json" class="hidden" />
      </div>
    </div>
    <div class="body">
      <div class="note">
        エクスポートは、あなたの全日付の予定をJSONでダウンロードします。<br/>
        インポートは、JSON内の同じ日付に上書き保存します（自分のデータだけに反映されます）。
      </div>
    </div>
  </section>
</main>

<!-- Firebase SDK (v9 Modular) -->
<script type="module">
  // ===== 1) ここを自分のFirebaseプロジェクト設定に差し替えてください =====
  // Firebaseコンソール -> プロジェクト設定 -> SDKの設定と構成 にある値
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    appId: "YOUR_APP_ID",
  };
  // ===============================================================

  // SDK読み込み
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { 
    getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, getDocs, collection, query, where, orderBy, limit, writeBatch
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // 初期化
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ===== DOM参照 =====
  const appRoot = document.getElementById('app');
  const userInfo = document.getElementById('userInfo');
  const signInBtn = document.getElementById('signInBtn');
  const signOutBtn = document.getElementById('signOutBtn');

  const datePicker = document.getElementById('datePicker');
  const todayBtn = document.getElementById('todayBtn');
  const scheduleText = document.getElementById('scheduleText');
  const saveBtn = document.getElementById('saveBtn');
  const updatedAtEl = document.getElementById('updatedAt');

  const prevMonthBtn = document.getElementById('prevMonthBtn');
  const nextMonthBtn = document.getElementById('nextMonthBtn');
  const monthLabel = document.getElementById('monthLabel');
  const calGrid = document.getElementById('calendar');

  const exportBtn = document.getElementById('exportBtn');
  const importFile = document.getElementById('importFile');

  // ===== ユーティリティ =====
  const TZ = 'Asia/Tokyo';
  const pad2 = (n)=>String(n).padStart(2,'0');
  const toDateKey = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; // YYYY-MM-DD

  function todayJST(){
    // ブラウザのローカルタイムでOK（日本での運用想定）。厳密にJSTにしたい場合はIntl.DateTimeFormatのtimeZoneを活用。
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), now.getDate());
  }
  function fromDateInput(val){
    const [y,m,d] = val.split('-').map(Number);
    return new Date(y, m-1, d);
  }
  function toHuman(dt){
    return dt.toLocaleString('ja-JP', { timeZone: TZ, dateStyle:'medium', timeStyle:'short' });
  }

  // ===== 認証 =====
  signInBtn.addEventListener('click', async ()=>{
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider).catch(err=>alert(err.message));
  });
  signOutBtn.addEventListener('click', async ()=>{
    await signOut(auth);
  });

  onAuthStateChanged(auth, (user)=>{
    if(user){
      userInfo.textContent = user.displayName ? `${user.displayName} さん` : user.email;
      signInBtn.classList.add('hidden');
      signOutBtn.classList.remove('hidden');
      appRoot.classList.remove('hidden');
      initAfterLogin();
    }else{
      userInfo.textContent = '未ログイン';
      signInBtn.classList.remove('hidden');
      signOutBtn.classList.add('hidden');
      appRoot.classList.add('hidden');
    }
  });

  // ===== データ構造 =====
  // Firestore: users/{uid}/schedules/{YYYY-MM-DD}  -> { text: string, updatedAt: Timestamp }

  async function loadSchedule(uid, dateKey){
    const ref = doc(db, 'users', uid, 'schedules', dateKey);
    const snap = await getDoc(ref);
    if(snap.exists()){
      const data = snap.data();
      return { text: data.text || '', updatedAt: data.updatedAt?.toDate?.() || null };
    }
    return { text: '', updatedAt: null };
  }

  async function saveSchedule(uid, dateKey, text){
    const ref = doc(db, 'users', uid, 'schedules', dateKey);
    await setDoc(ref, {
      text,
      updatedAt: new Date()
    }, { merge: true });
  }

  // 月の有無をざっくり知るためのクエリ（当月範囲に絞って取得）
  async function listSchedulesForMonth(uid, year, month){
    const start = new Date(year, month, 1);
    const end   = new Date(year, month+1, 1);
    // Firestoreは日付キーが文字列なので where ではなくローカルフィルタにします（ドキュメントIDクエリを使うなら別手法）
    const colRef = collection(db, 'users', uid, 'schedules');
    const all = await getDocs(colRef);
    const result = new Set();
    all.forEach(docSnap=>{
      const id = docSnap.id; // YYYY-MM-DD
      const m = id.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return;
      const dt = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
      if(dt >= start && dt < end){
        if(docSnap.data()?.text) result.add(id);
      }
    });
    return result; // Set of YYYY-MM-DD
  }

  // ===== 画面制御 =====
  let currentDate = todayJST(); // 選択中日付
  let currentMonth = new Date(todayJST().getFullYear(), todayJST().getMonth(), 1);

  function setDatePickerTo(date){
    datePicker.value = `${date.getFullYear()}-${pad2(date.getMonth()+1)}-${pad2(date.getDate())}`;
  }

  async function refreshEditor(uid){
    const key = toDateKey(currentDate);
    const { text, updatedAt } = await loadSchedule(uid, key);
    scheduleText.value = text || '';
    updatedAtEl.textContent = updatedAt ? `保存日時: ${toHuman(updatedAt)}` : '保存日時: —';
  }

  async function buildCalendar(uid){
    // 月情報
    const y = currentMonth.getFullYear();
    const m = currentMonth.getMonth(); // 0-based
    monthLabel.textContent = `${y}年 ${m+1}月`;
    calGrid.innerHTML = '';

    // 曜日ラベルの下に日セルを並べる
    const firstDay = new Date(y, m, 1).getDay(); // 0:日
    const daysInMonth = new Date(y, m+1, 0).getDate();
    const prevMonthDays = new Date(y, m, 0).getDate();

    // 当月に保存がある日
    const savedSet = await listSchedulesForMonth(uid, y, m);

    // 42セル（6週）に合わせる
    const totalCells = 42;
    for(let i=0;i<totalCells;i++){
      const cell = document.createElement('div');
      cell.className = 'day';

      const dayNum = i - firstDay + 1;
      let cellDate, inactive=false;

      if(i < firstDay){
        // 前月
        const d = prevMonthDays - (firstDay - 1 - i);
        cellDate = new Date(y, m-1, d);
        inactive = true;
      }else if(dayNum > daysInMonth){
        // 翌月
        const d = dayNum - daysInMonth;
        cellDate = new Date(y, m+1, d);
        inactive = true;
      }else{
        // 当月
        cellDate = new Date(y, m, dayNum);
      }

      if(inactive) cell.classList.add('inactive');
      if(toDateKey(cellDate) === toDateKey(todayJST())) cell.classList.add('todayMark');

      const head = document.createElement('header');
      const num = document.createElement('div');
      num.className = 'num';
      num.textContent = cellDate.getDate();

      const mark = document.createElement('div');
      if(savedSet.has(toDateKey(cellDate))){
        const dot = document.createElement('span');
        dot.className = 'dot';
        mark.appendChild(dot);
      }

      head.appendChild(num);
      head.appendChild(mark);

      const jumpBtn = document.createElement('button');
      jumpBtn.textContent = '開く';
      jumpBtn.addEventListener('click', ()=>{
        currentDate = cellDate;
        setDatePickerTo(currentDate);
        refreshEditor(uid);
        // カレンダーも当該月へ移動（他月セルから来た場合）
        currentMonth = new Date(cellDate.getFullYear(), cellDate.getMonth(), 1);
        buildCalendar(uid);
        window.scrollTo({ top: 0, behavior:'smooth' });
      });

      cell.appendChild(head);
      cell.appendChild(jumpBtn);
      calGrid.appendChild(cell);
    }
  }

  function initAfterLogin(){
    const user = auth.currentUser;
    if(!user) return;

    // 初期表示：今日
    currentDate = todayJST();
    currentMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    setDatePickerTo(currentDate);
    refreshEditor(user.uid);
    buildCalendar(user.uid);
  }

  // ===== イベント =====
  datePicker.addEventListener('change', ()=>{
    currentDate = fromDateInput(datePicker.value);
    const user = auth.currentUser; if(user) refreshEditor(user.uid);
    // 月も同期
    currentMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    if(user) buildCalendar(user.uid);
  });

  todayBtn.addEventListener('click', ()=>{
    currentDate = todayJST();
    setDatePickerTo(currentDate);
    const user = auth.currentUser; if(user) { refreshEditor(user.uid); currentMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1); buildCalendar(user.uid); }
  });

  prevMonthBtn.addEventListener('click', ()=>{
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1);
    const user = auth.currentUser; if(user) buildCalendar(user.uid);
  });

  nextMonthBtn.addEventListener('click', ()=>{
    currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1);
    const user = auth.currentUser; if(user) buildCalendar(user.uid);
  });

  saveBtn.addEventListener('click', async ()=>{
    const user = auth.currentUser; if(!user) return alert('ログインしてください');
    saveBtn.disabled = true;
    try{
      await saveSchedule(user.uid, toDateKey(currentDate), scheduleText.value.trim());
      await refreshEditor(user.uid);
      await buildCalendar(user.uid);
    }catch(e){
      alert('保存に失敗しました: ' + e.message);
    }finally{
      saveBtn.disabled = false;
    }
  });

  exportBtn.addEventListener('click', async ()=>{
    const user = auth.currentUser; if(!user) return alert('ログインしてください');
    // 全ドキュメントを取得してJSON化
    const colRef = collection(db, 'users', user.uid, 'schedules');
    const snaps = await getDocs(colRef);
    const out = {};
    snaps.forEach(s=>{
      const d = s.data();
      out[s.id] = { text: d.text || '', updatedAt: d.updatedAt?.toDate?.()?.toISOString?.() || null };
    });
    const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'schedules_export.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  importFile.addEventListener('change', async (e)=>{
    const user = auth.currentUser; if(!user) return alert('ログインしてください');
    const file = e.target.files?.[0]; if(!file) return;
    try{
      const text = await file.text();
      const json = JSON.parse(text);
      const batch = writeBatch(db);
      const keys = Object.keys(json);
      if(keys.length === 0) return alert('インポート対象がありません。');

      keys.forEach(k=>{
        if(!/^\d{4}-\d{2}-\d{2}$/.test(k)) return; // YYYY-MM-DDのみ受け付け
        const ref = doc(db, 'users', user.uid, 'schedules', k);
        const val = String(json[k]?.text || '');
        batch.set(ref, { text: val, updatedAt: new Date() }, { merge: true });
      });
      await batch.commit();
      // 画面更新
      await refreshEditor(user.uid);
      await buildCalendar(user.uid);
      alert('インポートしました');
    }catch(err){
      console.error(err);
      alert('インポートに失敗しました: ' + err.message);
    }finally{
      importFile.value = '';
    }
  });
</script>

<!-- 参考: Firestore ルール（概念） 
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId}/schedules/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
  ※実運用前にFirebaseコンソールの「ルール」で設定してください。
-->
</body>
</html>
